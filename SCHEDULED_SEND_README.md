# SMS/MAIL 发送功能说明

## 概要

本功能允许您为 SMS 和 MAIL 设置三种发送模式:即时发送、定时发送和预约发送。

## 功能特点

### 1. 对象设定页面的新选项

在对象设定页面(`/target-settings`)中,每个 segment 的 SMS 和 MAIL 操作现在包含:

- **送信モード**: 选择"即時送信"、"時刻送信"或"予約送信"
- **送信時刻**: 当选择時刻送信时,可以设置每天发送的具体时间(HH:mm 格式)
- **送信までの時間(分)**: 当选择予約送信时,可以设置延迟发送的分钟数

### 2. 即时发送 (即時送信)

- 应募者符合条件后立即发送 SMS/MAIL
- MEMO 显示: `【标签】：sms送信済/mail送信済，2025/10/17, 14:30`

### 3. 定时发送 (時刻送信)

- 应募者符合条件后创建定时任务
- 每天在设定的时间自动发送
- MEMO 显示: `【标签】：SMS（時刻送信2025/10/18）/MAIL（時刻送信2025/10/18），2025/10/17, 14:30`
- 发送成功后才写入历史记录表格

### 4. 预约发送 (予約送信)

- 应募者符合条件后创建延迟任务
- 在指定的分钟数后自动发送(例如:30 分钟后)
- MEMO 显示: `【标签】：SMS（予約送信30分）/MAIL（予約送信30分），2025/10/17, 14:30`
- 发送成功后才写入历史记录表格

## 使用方法

### 第 1 步: 设置发送模式

1. 访问 `/target-settings` 页面
2. 创建或编辑 segment
3. 在 SMS 或 MAIL 部分:
   - 勾选启用 SMS/MAIL
   - 选择**送信モード**:
     - **即時送信**: 立即发送
     - **時刻送信**: 每日定时发送
     - **予約送信**: 延迟发送
   - 如果选择時刻送信,设置**送信時刻**(例如: 09:00)
   - 如果选择予約送信,设置**送信までの時間**(例如: 30 分)
4. 保存 segment

### 第 2 步: 启动定时任务执行器

定时任务执行器会定期检查并执行到期的任务。

**Windows:**

```cmd
run_scheduler.cmd <UID>
```

**或直接使用 Python:**

```cmd
python scripts\scheduled_task_executor.py <UID>
```

**Linux/Mac:**

```bash
python3 scripts/scheduled_task_executor.py <UID>
```

将 `<UID>` 替换为您的用户 ID。

### 第 3 步: 保持执行器运行

定时任务执行器需要持续运行以执行定时任务。您可以:

1. **在终端中运行** (简单,但关闭终端后停止)
2. **使用 Windows 服务** 或 **Linux systemd** (推荐用于生产环境)
3. **使用进程管理器** 如 PM2 (适用于 Node.js 环境)

## 工作流程

### 即时发送流程

1. 应募者被判定为对象
2. 立即发送 SMS/MAIL
3. 在 Jobbox 的 MEMO 中记录发送状态
4. 写入历史记录表格

### 定时发送流程

1. 应募者被判定为对象
2. 创建定时任务到 Firestore
3. 在 Jobbox 的 MEMO 中记录预约发送信息(包含预定日期)
4. 定时任务执行器在设定时间发送 SMS/MAIL
5. 发送成功后写入历史记录表格

### 预约发送流程

1. 应募者被判定为对象
2. 创建延迟任务到 Firestore
3. 在 Jobbox 的 MEMO 中记录预约发送信息(包含延迟分钟数)
4. 定时任务执行器在延迟时间后发送 SMS/MAIL
5. 发送成功后写入历史记录表格

## Firestore 数据结构

定时任务存储在 `accounts/{uid}/scheduled_tasks` 集合中:

```typescript
{
  uid: string,
  taskType: 'sms' | 'mail',
  status: 'pending' | 'completed' | 'failed',
  sendMode?: 'scheduled' | 'delayed',  // 発送モード
  scheduledTime?: string,  // 'HH:mm' 格式(時刻送信使用)
  delayMinutes?: number,   // 延迟分钟数(予約送信使用)
  nextRun: number,        // Unix时间戳(毫秒)
  to: string,             // 收件人(电话号码或邮箱)
  template: string,       // 消息模板
  applicantDetail: {      // 应募者信息用于token替换
    applicant_name: string,
    job_title: string,
    employer_name: string,
    // ... 其他字段
  },
  segmentId: string,      // 触发此任务的segment ID
  ouboNo: string,         // 応募No
  subject?: string,       // 邮件主题(仅mail类型)
  createdAt: number,      // 创建时间
  updatedAt: number,      // 更新时间
  completedAt?: number,   // 完成时间
  errorMsg?: string       // 错误信息(如果失败)
}
```

## 注意事项

1. **定时任务执行器必须持续运行**才能执行定时发送
2. 定时任务在每天的指定时间执行,如果错过会在第二天同一时间再次尝试
3. 定时发送的历史记录在**实际发送后**才写入,而不是创建任务时
4. MEMO 中的预约日期是下一次执行的日期
5. 如果 SMS 或 MAIL 发送失败,任务状态会更新为'failed',并记录错误信息

## 环境变量

定时任务执行器支持以下环境变量:

- `DRY_RUN_SMS`: 设置为 '1' 或 'true' 启用 SMS 干跑模式
- `DRY_RUN_MAIL`: 设置为 '1' 或 'true' 启用 MAIL 干跑模式
- `UID`: 用户 ID(可通过命令行参数覆盖)

## 故障排查

### 定时任务未执行

1. 检查定时任务执行器是否正在运行
2. 检查 Firestore 中的 `scheduled_tasks` 集合
3. 查看执行器的日志输出

### MEMO 未正确显示预约信息

1. 确认 segment 保存时包含了 `sendMode` 和 `scheduledTime` 字段
2. 检查浏览器控制台是否有错误
3. 重新加载页面

### 发送失败

1. 检查 API 配置是否正确
2. 查看历史记录表格中的错误信息
3. 检查收件人信息(电话号码/邮箱)是否有效

## 示例配置

### SMS 定时发送示例

```
保存タイトル: 男性候補者_朝9時
送信先: SMS ✓
氏名: 漢字 ✓
年齢範囲: 男性 20-35歳

SMS送信モード: ● 時刻送信
送信時刻: 09:00
※ 毎日この時刻に送信されます

SMS本文:
【{{会社名}}】{{氏名}}様、{{職種}}のご応募ありがとうございます。
詳細はこちら: https://...
```

### MAIL 即时发送示例

```
保存タイトル: 女性候補者_即時
送信先: MAIL ✓
氏名: カタカナ ✓ ひらがな ✓
年齢範囲: 女性 25-40歳

メール送信モード: ● 即時送信

件名: {{職種}}のご応募について
本文:
{{氏名}}様

この度は{{会社名}}の{{職種}}にご応募いただき、誠にありがとうございます。
...
```

### SMS 预约发送示例

```
保存タイトル: 重要候補者_30分後
送信先: SMS ✓
氏名: 漢字 ✓
年齢範囲: 不限

SMS送信モード: ● 予約送信
送信までの時間: 30 分後
※ 対象判定後、指定した分数が経過してから送信されます

SMS本文:
【{{会社名}}】{{氏名}}様、{{職種}}のご応募ありがとうございます。
詳細はこちら: https://...
```

## 更新日志

- 2025/10/17: 初版发布,添加 SMS/MAIL 定时发送功能
- 2025/01/20: 添加预约发送(予約送信)功能,允许设置延迟发送分钟数
